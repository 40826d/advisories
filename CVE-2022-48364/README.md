# Moderator identity disclosure in Mastodon when approving appeal of sensitive marked statuses

## Advisory Info

- Vendor: [Mastodon gGmbH](https://github.com/mastodon)
- Product: [Mastodon](https://github.com/mastodon/mastodon)
- Affected Versions: >= 3.5.0 < 3.5.3
- Patched Versions: 3.5.3
- Vendor Publication Date: 2022-05-26

## Vulnerability Info

- Weakness: [CWE-200: Exposure of Sensitive Information to an Unauthorized Actor](https://cwe.mitre.org/data/definitions/200.html)
- CVE: [CVE-2022-48364](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-48364)

## Summary

Mastodon [v3.5.0](https://github.com/mastodon/mastodon/releases/tag/v3.5.0) introduced the ability for users to [appeal](https://docs.joinmastodon.org/admin/moderation/#individual-moderation) moderation actions taken by moderators on their instance.

Each Mastodon instance has a special account that represents the instance (often referred to as the representative account or [instance actor](https://github.com/mastodon/mastodon/issues/10453)) which is based on the instance's [domain name](https://docs.joinmastodon.org/admin/config/#local_domain) (`LOCAL_DOMAIN`).

The appeals feature in Mastodon uses the representative account to prevent the identity of the acting moderator from being revealed in the edit histories of the appealed posts they approve or deny.

Between Mastodon versions 3.5.0 and 3.5.3, the `undo_mark_statuses_as_sensitive` method in [approve_appeal_service.rb](https://github.com/mastodon/mastodon/blob/25d3dc4373531071f444d8e44e44cd21970cb373/app/services/approve_appeal_service.rb#L56) used the logged-in user context `@current_account.id` instead of the representative account context `representative_account.id` in the call to `UpdateStatusService`:

```diff
diff --git a/app/services/approve_appeal_service.rb b/app/services/approve_appeal_service.rb
index 37a08b46e386..96aaaa7d078b 100644
--- a/app/services/approve_appeal_service.rb
+++ b/app/services/approve_appeal_service.rb
@@ -52,8 +52,9 @@ def undo_delete_statuses!
   end

   def undo_mark_statuses_as_sensitive!
+    representative_account = Account.representative
     @strike.statuses.includes(:media_attachments).each do |status|
-      UpdateStatusService.new.call(status, @current_account.id, sensitive: false) if status.with_media?
+      UpdateStatusService.new.call(status, representative_account.id, sensitive: false) if status.with_media?
     end
   end
```

This resulted in moderator identity disclosure when a moderator or admin approved the appeal of a user whose media post was marked as sensitive. The user who performed the reversal would have been recorded in the edit history for the post which can be viewed by anyone who can see the post.

## Steps to Reproduce

1. As a user on a Mastodon instance (herein `https://instance`), make a status update with a photo or video attached.

2. As a moderator or admin on the same instance, open the status update in the admin panel and select "Report" followed by "Mark as sensitive".

3. As the poster, browse to [https://instance/disputes/strikes](https://instance/disputes/strikes), select the strike, and submit the appeal form.

4. As the moderator, browse to [https://instance/admin/disputes/appeals?status=pending](https://instance/admin/disputes/appeals?status=pending), select the appeal, and approve it.

5. As either user, browse to the status update and select the "Edited" dropdown. Observe that the acting moderator's identity is shown in the edit history instead of the representative account's identity.

## Impact

Mastodon users whose media posts were marked as sensitive by moderators and later successfully appealed would have been able to identify the user who performed the reversal.

## Recommendations

If you run a Mastodon server, you should update to Mastodon version 3.5.3 or above. Other ActivityPub server implementations are not affected.

## Timeline

- 2022-04-20: Vulnerability discovered
- 2022-04-20: Vulnerability reported to vendor
- 2022-04-21: Vendor acknowledged receipt of advisory
- 2022-05-26: Vendor committed fix ([PR #18525](https://github.com/mastodon/mastodon/pull/18525))
- 2022-05-26: Vendor released fix ([v3.5.3](https://github.com/mastodon/mastodon/releases/tag/v3.5.3))
- 2022-05-26: Vendor disclosed via release changelog
